<!DOCTYPE html>
<html lang="pl">
<script src="/js/lunr.min.js"></script><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Domowy klaster Kubernetesa na Raspberry Pi | Consdata - blog techniczny</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Domowy klaster Kubernetesa na Raspberry Pi" />
<meta name="author" content="bradlinski" />
<meta property="og:locale" content="pl" />
<meta name="description" content="W tym artykule pokażę jak postawić klaster kubernetesa na popularnych płytkach Raspberry Pi. Czas post pandemicznego kryzysu półprzewodników, niedoboru płytek oraz ich horrendalnych cen na serwisach aukcyjnych, to idealny moment na taki poradnik ;)" />
<meta property="og:description" content="W tym artykule pokażę jak postawić klaster kubernetesa na popularnych płytkach Raspberry Pi. Czas post pandemicznego kryzysu półprzewodników, niedoboru płytek oraz ich horrendalnych cen na serwisach aukcyjnych, to idealny moment na taki poradnik ;)" />
<link rel="canonical" href="https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html" />
<meta property="og:url" content="https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html" />
<meta property="og:site_name" content="Consdata - blog techniczny" />
<meta property="og:image" content="https://blog.consdata.tech/assets/img/posts/2022-10-03-k8s-raspberry-pi/cluster.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-10-14T02:50:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://blog.consdata.tech/assets/img/posts/2022-10-03-k8s-raspberry-pi/cluster.jpg" />
<meta property="twitter:title" content="Domowy klaster Kubernetesa na Raspberry Pi" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"bradlinski"},"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html"},"description":"W tym artykule pokażę jak postawić klaster kubernetesa na popularnych płytkach Raspberry Pi. Czas post pandemicznego kryzysu półprzewodników, niedoboru płytek oraz ich horrendalnych cen na serwisach aukcyjnych, to idealny moment na taki poradnik ;)","url":"https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html","image":"https://blog.consdata.tech/assets/img/posts/2022-10-03-k8s-raspberry-pi/cluster.jpg","headline":"Domowy klaster Kubernetesa na Raspberry Pi","dateModified":"2022-10-14T02:50:00-05:00","datePublished":"2022-10-14T02:50:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,700,600,500,300,200,100,800,900" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,600,500,300,200,100,800,900" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@100;400;500;700&display=swap" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.consdata.tech/feed.xml" title="Consdata - blog techniczny" /><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NFV6DPR');</script>


  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>---
---
<nav class="site-header">
    <div class="container">
        <div class="header navbar-default" role="navigation">
            <div class="header-brand">
                <div class="nav navbar-nav">
                    <div class="nav-link"><a href="/">BLOG.CONSDATA.TECH</a></div>
                </div>

                <div class="mobile-search">
                    
<form action="/search.html" method="get">

    <div class="search-input-container">
        <input type="text" placeholder="Szukaj..." id="search-box-mobile" name="query" class="search-input" autocomplete="off">
        <i class="fa fa-search search-icon" onclick="expandInputMobile()"></i>
    </div>
</form>

<script>
    const inputMobile = document.getElementById("search-box-mobile");
    const logo = document.getElementById("header-logo");
    const expandInputMobile = () => {
        inputMobile.classList.toggle("expanded");
        logo.classList.toggle("header-logo");
        logo.classList.toggle("logo-invisible");
    };
</script>

                </div>
            </div>
            <div id="header-links" class="mobile-nav">
                <a class="header-logo" href="https://consdata.com/pl">
                    <img src="/assets/img/logo-nowe.png" alt="consdata.com">
                </a>
                <div class="feed-subscribe">
                    <a href="/feed.xml">
                    <svg class="svg-icon">
                        <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
                    </svg>
                    </a>
                </div>
                
            </div>

        </div>
    </div>
</nav>
<script>
    function navigate(baseUrl) {
        const queryParams = window.location.search;
        window.location.href = baseUrl + queryParams;
    }
</script>





<div class="navigation-bar">
    <div class="row">
        <div class="col-15 desktop-navbar">
            <div class="col-2-3 navbar-links">
                <div class="navigation-tags">
                    
                        
                        <a href="/search.html?query=programming">
                        
                        PROGRAMMING
                        </a>
                    
                        
                        <a href="/search.html?query=serverless">
                        
                        SERVERLESS
                        </a>
                    
                        
                        <a href="/search.html?query=mongodb">
                        
                        MONGODB
                        </a>
                    
                        
                        <a href="/search.html?query=gcp">
                        
                        GCP
                        </a>
                    
                        
                        <a href="/search.html?query=frontend">
                        
                        FRONTEND
                        </a>
                    
                </div>
                
<form action="/search.html" method="get">

    <div class="search-input-container">
        <input type="text" placeholder="Szukaj..." id="search-box" name="query" class="search-input" autocomplete="off">
        <i class="fa fa-search search-icon" onclick="expandInputDesktop()"></i>
    </div>
</form>

<script>
    const inputDesktop = document.getElementById("search-box");
    const expandInputDesktop = () => {
        inputDesktop.classList.toggle("expanded");
    };
</script>

            </div>
            <div class="col-1-3">
                <a href="https://app2.salesmanago.pl/mscf/e7yrrpjmxbm7bahc/default/Landing_page_newsletter_techniczny.htm"
                   class="newsletter-link">
                    <div class="newsletter-button">
                        Zapisz się na newsletter techniczny
                    </div>
                </a>
            </div>
        </div>
        <div class="col-15 mobile-navbar">
            <div class="navigation-tags">
                
                
                    <a href="/search.html?query=programming">
                        
                        PROGRAMMING
                    </a>
                    
                
                    <a href="/search.html?query=serverless">
                        
                        SERVERLESS
                    </a>
                    
                
                    <a href="/search.html?query=mongodb">
                        
                        MONGODB
                    </a>
                    
                
                    <a href="/search.html?query=gcp">
                        
                        GCP
                    </a>
                    
                
                    <a href="/search.html?query=frontend">
                        
                        FRONTEND
                    </a>
                    
            </div>
            <a href="https://app2.salesmanago.pl/mscf/e7yrrpjmxbm7bahc/default/Landing_page_newsletter_techniczny.htm"
               class="newsletter-link">
                <div class="newsletter-button">Zapisz się na newsletter techniczny</div>
            </a>
        </div>
    </div>
</div>
<main class="page-content" aria-label="Content">
    


<div class="blog">
    <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
        <header>
            <div class="row back-link-row">
    <div class="col-15">
        <a href="/" class="main-page-link-container">
            <i class="fa fa-arrow-left"></i>
                Wszystkie wpisy
        </a>
    </div>
</div>

            <div class="row">
                <div class="col-15">
                    <h1 class="post-big-title p-name" itemprop="name headline">Domowy klaster Kubernetesa na Raspberry Pi</h1>
                </div>
            </div>
            <div class="row">
                <div class="col-15">
                    <div class="post-metadata">

    <a href="/authors/bradlinski.html" class="author-name">
        <img class="big-author-image" src="/assets/img/authors/bradlinski.webp" alt="author"></a>
    <div class="post-info"><a href="/authors/bradlinski.html" class="author-name-metadata">Bartosz Radliński</a>
        <span>
14

października



2022
</span>
    </div>


</div>

                </div>
                <div class="col-5">
                    

                </div>
            </div>
        </header>
        <div itemprop="articleBody" class="post-content-container">
            <div class="post-content-left-pane">
                <div class="post-content">
                    <div class=" big-post-tile-after-hours  post-highlight-image">
                        <img src="/assets/img/posts/2022-10-03-k8s-raspberry-pi/cluster.jpg" alt="postimage"/>
                    </div>
                    <div class="social-media-sharing">
                        <div id="share-bar">
    <div class="share-buttons">
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html"
           onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
           title="Podziel się na Facebooku">
            <i class="fa fa-facebook-official share-button"></i>
        </a>

        <a href="https://twitter.com/intent/tweet?text=Domowy klaster Kubernetesa na Raspberry Pi&url=https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html"
           onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
           title="Podziel się na Twitterze">
            <i class="fa fa-twitter share-button"> </i>
        </a>

        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html&title=Domowy klaster Kubernetesa na Raspberry Pi&source=Consdata - blog techniczny"
           onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
           title="Podziel się na LinkedIn">
            <i class="fa fa-linkedin share-button"></i>
        </a>

    </div>

</div>

                    </div>
                    <div id="myModal" class="modal">
                        <i id="modal-close" class="fa fa-times close" aria-hidden="true"
                           onclick="closeModal()"></i>
                        <img class="modal-content">
                    </div>
                    <p>W tym artykule pokażę jak postawić klaster kubernetesa na popularnych płytkach Raspberry Pi. Czas post pandemicznego kryzysu półprzewodników, niedoboru płytek oraz ich horrendalnych cen na serwisach aukcyjnych, to idealny moment na taki poradnik ;)</p>

<h2 id="przygotowanie-płytek">Przygotowanie płytek</h2>

<p>Potrzebne będą co najmniej dwie płytki Raspberry Pi 4+. W ostateczności worker node można postawić na wersji 3B. Niższe
wersje płytek są na architekturze 32-bit. O ile sam klaster można na niej postawić, o tyle aplikacji praktycznie nie ma. Jako bazę wykorzystamy system Raspberry Pi OS w wersji 64-bit. Można użyć
oczywiście dowolnego systemu, byle był 64-bit.
Ze strony <a href="https://www.raspberrypi.com/software/operating-systems/#raspberry-pi-os-64-bit">raspberrypi.com</a> pobieramy
wersję <code class="language-plaintext highlighter-rouge">lite</code> systemu, rozpakowujemy archiwum i kopiujemy na kartę microSd (klasy 10).
Zakładając, że karta jest reprezentowana przez urządzenie /dev/sdb:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>wypakowanyObraz.img <span class="nv">of</span><span class="o">=</span>/dev/sdb <span class="nv">bs</span><span class="o">=</span>4M <span class="nv">conv</span><span class="o">=</span>fsync
</code></pre></div></div>

<p>Bardzo ważne, aby karty sd były w dobrym stanie (idealnie, gdyby były nowe). Najistotniejsza jest karta użyta na maszynie master. Po dłuższym czasie użytkowania (około 2 lat) karta, którą miałem na głównej maszynie uległa degradacji. W efekcie w czasie inicjalizacji klastra otrzymywałem timeouty na requestach do <code class="language-plaintext highlighter-rouge">etcd</code>. Pomogła wymiana karty na nową.</p>

<p>Po uruchomieniu płytki przechodzimy przez wstępną konfigurację (zależnie od wersji systemu pojawi się konfigurator lub od razu zostaniem zalogowaniu na użytkownika ‘pi’).</p>

<p>Na początku przystępujemy do konfiguracji ssh. Otwieramy plik <code class="language-plaintext highlighter-rouge">/etc/ssh/sshd_config</code> i ustawiamy opcję <code class="language-plaintext highlighter-rouge">PermitRootLogin</code>
na <code class="language-plaintext highlighter-rouge">yes</code>. Następnie przechodzimy na konto root za pomocą <code class="language-plaintext highlighter-rouge">sudo su</code> i ustawiamy hasło wykorzystując <code class="language-plaintext highlighter-rouge">passwd</code>. Możemy
także nie ustawiać hasła i pozostawić domyślna wartość <code class="language-plaintext highlighter-rouge">prohibit-password</code>. W takim przypadku należy skopiować na płytkę klucz publiczny.
Na koniec włączamy usługę ssh:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start ssh <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>ssh
</code></pre></div></div>

<p>Alternatywnie można wykorzystać narzędzie <code class="language-plaintext highlighter-rouge">raspi-config</code> i włączyć ssh przechodząc do <code class="language-plaintext highlighter-rouge">Interface Options</code> &gt; <code class="language-plaintext highlighter-rouge">SSH</code>.</p>

<p>Jeśli planujemy bezprzewodowe połączenie płytek, możemy skorzystać z tego narzędzia do konfiguracji połączenia —
sekcja: <code class="language-plaintext highlighter-rouge">System Options</code></p>

<p>Niezależnie od wybranego interfejsu połączenia musimy zadbać o to, aby adresy IP maszyn były stałe. W tym celu otwieramy
plik <code class="language-plaintext highlighter-rouge">/etc/dhcpcd.conf</code> usuwamy całą zawartość i podajemy:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interface eth0
static <span class="nv">ip_address</span><span class="o">=</span>192.168.1.203/24
static <span class="nv">routers</span><span class="o">=</span>192.168.1.1
static <span class="nv">domain_name_servers</span><span class="o">=</span>192.168.1.1 8.8.8.8 8.8.4.4
</code></pre></div></div>

<p>Oczywiście adresy i interfejs dostosowujemy do własnych wymagań. Dla połączenia bezprzewodowego domyślnym interfejsem
jest <code class="language-plaintext highlighter-rouge">wlan0</code>. Osobiście cały klaster trzymam w podsieci, aby uniknąć konfliktów z innymi urządzeniami. Wykorzystuję
dedykowaną płytkę jako bramę do klastra.</p>

<p>Pozostało zrestartować usługę <code class="language-plaintext highlighter-rouge">dhcpcd</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart dhcpcd
</code></pre></div></div>

<p>Na koniec weryfikujemy, czy mamy połączenie pomiędzy wszystkimi płytkami i każda z nich ma dostęp do internetu.</p>

<p>Po konfiguracji należy upewnić się, że w <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code> wśród serwerów dns nie mamy <code class="language-plaintext highlighter-rouge">127.0.0.1</code>. Pozostawienie tego wpisu spowoduje błędy poda CoreDNS. Posiada on mechanizmy wykrywania pętli.</p>

<h2 id="konfiguracja-węzłów">Konfiguracja węzłów</h2>

<p>Poniższe instrukcje należy wykonać dla każdej maszyny.</p>

<h3 id="konfiguracja-systemu">Konfiguracja systemu</h3>

<p>Rozpoczynamy od instalacji potrzebnych pakietów:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install
</span>lsb-release <span class="se">\</span>
apt-transport-https <span class="se">\</span>
ca-certificates <span class="se">\</span>
software-properties-common <span class="se">\</span>
arptables <span class="se">\</span>
ebtables <span class="se">\</span>
libseccomp2 <span class="se">\</span>
jq
</code></pre></div></div>

<p>Następnie musimy zapewnić dostępność modułów jądra <code class="language-plaintext highlighter-rouge">overlay</code> i <code class="language-plaintext highlighter-rouge">br_netfilter</code>. W tym celu tworzymy
plik <code class="language-plaintext highlighter-rouge">/etc/modules-load.d/k8s.conf</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>overlay
br_netfilter
</code></pre></div></div>

<p>W ten sposób po każdym restarcie moduły będą wczytane automatycznie.</p>

<p>Aby możliwa była komunikacja między podami musimy jeszcze stworzyć plik <code class="language-plaintext highlighter-rouge">/etc/sysctl.d/k8s.conf</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward=1
</code></pre></div></div>

<p>Moduł <code class="language-plaintext highlighter-rouge">overlay</code> pozwala na wykorzystanie systemu plików overlay, dzięki czemu kontenery będą miały “swoją” wersję systemu plików (więcej o overlayFs <a href="https://www.kernel.org/doc/html/latest/filesystems/overlayfs.html">tutaj</a>. 
Moduł <code class="language-plaintext highlighter-rouge">br_netfilter</code> wraz z ustawieniami z <code class="language-plaintext highlighter-rouge">/etc/sysctl.d/k8s.conf</code> pozwoli na komunikację między podami. Ruch odbywający się między kontenerami w ramach emulowanego mostu (bridge network) będzie podlegał regułom zawartym w iptables węzła (za konstrukcję reguł odpowiada <code class="language-plaintext highlighter-rouge">kube-proxy</code>). <code class="language-plaintext highlighter-rouge">net.ipv4.ip_forward</code> pozwala na przekierowanie pakietów z jednego interfejsu sieciowego na inny (system działa ja router).</p>

<p>Na koniec dodajemy do <code class="language-plaintext highlighter-rouge">/boot/cmdline.txt</code>: <code class="language-plaintext highlighter-rouge">cgroup_enable=cpuset cgroup_enable=memory swapaccount=1</code>
<code class="language-plaintext highlighter-rouge">cpuset</code> oraz <code class="language-plaintext highlighter-rouge">memory</code> w kontekście k8s pozwala na ograniczenie zasobów poszczególnym podom. Więcej o control groups <a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v1/cgroups.html">tutaj</a>. Włączenie <code class="language-plaintext highlighter-rouge">swapaccount</code> powoduje śledzenie i ograniczenie wykorzystania pamięci swap w ramach kontenerów. Istotne jest to z tego względu, że k8s nie wspiera obecnie pamięci swap (wsparcie alpha od wersji 1.22). Dlatego też na każdym nodzie musimy wyłączyć pamięć swap za pomocą komendy.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl disable dphys-swapfile.service
</code></pre></div></div>

<p>Jeśli swap nie będzie wyłączony, inicjalizacja klastra zakończy się błędem.</p>

<h3 id="instalacja-containerd">Instalacja containerd</h3>

<p>Od wersji <code class="language-plaintext highlighter-rouge">1.20</code> kubernetes przestał wspierać Dockera jako domyślne środowisko uruchamiania dla kontenerów. 
Docker nie implementuje standardu <code class="language-plaintext highlighter-rouge">CRI</code>. Był wspierany przez kuberenetesa, gdyż nie było wystarczająco dobrych/popularnych
alternatyw (no i na początku standard CRI nawet nie istniał). Obecnie sytuacja jest nieco inna. W obecnym kształcie docker jest tylko pośrednikiem między k8s, a
containerd. Dodatkowo wymaga to utrzymywania dodatkowej warstwy implementującej CRI - docker-shim (został usunięty w wersji 1.24 więcej informacji <a href="https://kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/check-if-dockershim-removal-affects-you/">tutaj</a>).</p>

<p>Na naszym klastrze zainstalujemy containerd.</p>

<p>Binarki containerd pobieramy z oficjalnego repozytorium i umieszczamy ja w katalogu <code class="language-plaintext highlighter-rouge">/usr/local</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/containerd/containerd/releases/download/vWERSJA/containerd-WERSJA-linux-arm64.tar.gz
</code></pre></div></div>

<p>W moim przypadku <code class="language-plaintext highlighter-rouge">WERSJA=1.6.6</code>.</p>

<p>Następnie tworzymy katalog <code class="language-plaintext highlighter-rouge">/etc/containerd</code> i uzupełniamy go domyślną konfiguracją za pomocą:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
</code></pre></div></div>

<p>W wygenerowanym pliku odnajdujemy <code class="language-plaintext highlighter-rouge">SystemdCgroup = false</code> i zmieniamy na <code class="language-plaintext highlighter-rouge">SystemdCgroup = true</code>.</p>

<p>Następnie tworzymy katalog <code class="language-plaintext highlighter-rouge">/usr/local/lib/systemd/system/</code> i zapisujemy w nim definicję usługi dostępną
na</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://raw.githubusercontent.com/containerd/containerd/main/containerd.service
</code></pre></div></div>

<p>Containerd zarządza obrazami, siecią i storagem.</p>

<p>W kolejnym kroku instalujemy program <code class="language-plaintext highlighter-rouge">runc</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/opencontainers/runc/releases/download/vWERSJA_RUNC/runc.arm64
</code></pre></div></div>
<p>W moim przypadku <code class="language-plaintext highlighter-rouge">WERSJA_RUNC=1.1.3</code> i instalujemy ją pod ścieżką <code class="language-plaintext highlighter-rouge">/usr/local/sbin/runc</code> z prawami dostępu 755.</p>

<p>Runc to narzędzie najniższego poziomu, odpowiada za tworzenie i uruchamianie kontenerów.</p>

<p>W repozytorium containerd znaleźć można także archiwa z pluginami CNI. Nie musimy ich specjalnie instalować. W dalszych krokach będziemy aplikować do k8s manifest konkretnego pluginu. Po zaaplikowaniu, binarki zainstalowane zostaną automatycznie za pomocą initConteinera (przynajmniej jeśli chodzi o pluginy, które testowałem).</p>

<p>Pozostaje nam już tylko przeładować usługi i włączyć usługę containerd:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable</span> <span class="nt">--now</span> containerd
</code></pre></div></div>

<p>Po wszystkim restartujemy system.</p>

<h3 id="instalacja-kubeadm-kubectl-i-kubelet">Instalacja kubeadm, kubectl i kubelet</h3>

<p>Dodajemy klucz repozytorium k8s:</p>

<p><code class="language-plaintext highlighter-rouge">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</code></p>

<p>Tworzymy <code class="language-plaintext highlighter-rouge">pliki /etc/apt/sources.list.d/k8s.list</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deb http://apt.kubernetes.io/ kubernetes-xenial main
</code></pre></div></div>

<p>I instalujemy aplikacje:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install </span>kubeadm kubectl kubelet
</code></pre></div></div>

<p>Po pomyślnej instalacji uruchamiamy usługę kubelet:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart kubelet
</code></pre></div></div>

<h2 id="konfiguracja-mastera">Konfiguracja mastera</h2>

<p>Mając już przygotowaną bazę dla wszystkich węzłów, możemy przejść do inicjalizacji mastera. Wykonujemy polecenie:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm init 
</code></pre></div></div>

<p>Po poprawnej inicjalizacji zwrócone zostanie polecenie wraz z tokenem, pozwalające na przyłączenie workerów do
klastra. Polecenie to można także wygenerować, uruchamiając na masterze:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm token create <span class="nt">--print-join-command</span> 2&gt;/dev/null
</code></pre></div></div>

<p>Na koniec pozostaje nam zainstalować jeden z dostępnych pluginów CNI, wymaganych do działania klastra k8s. Osobiście testowałem pluginy:</p>
<ul>
  <li>wave (<a href="https://cloud.weave.works/k8s/net?k8s-version=">manifest</a> - w url manifestu musimy wskazać konkretną wersję pozyskaną za pomocą <code class="language-plaintext highlighter-rouge">$(kubectl version | base64 | tr -d '\n'))</code></li>
  <li>flannel (<a href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml">manifest</a>)</li>
  <li>calico (<a href="https://docs.projectcalico.org/manifests/calico.yam">manifest</a>)</li>
</ul>

<p>W przypadku pluginu flannel musimy do komendy iniciującej klaster dodać parametr:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm init <span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16
</code></pre></div></div>
<p>Jest to domyślna pula adresów rezerwowana dla podów w pluginie flannel. Z jakiegoś powodu nie jest on w stanie wykryć puli zaalokowanej przez k8s przy inicjalizacji.</p>

<p>Co prawda jest to mało prawdopodobne w przypadku domowego klastra, ale należy pamiętać, że pule adresów wskazane w ramach parametrów <code class="language-plaintext highlighter-rouge">pod-network-cidr</code> (jeśli nie podamy k8s sam zaalokuje adresy) i <code class="language-plaintext highlighter-rouge">service-cidr</code> (dla tego parametru domyślną wartością jest 10.96.0.0/12) nie powinny być zajęte.</p>

<p>Przed zaaplikowaniem manifestu przygotowujemy konfigurację dla kubectl. W tym celu kopiujemy
plik <code class="language-plaintext highlighter-rouge">/etc/kubernetes/kubelet.conf</code> pod ścieżkę <code class="language-plaintext highlighter-rouge">/root/.kube/config</code></p>

<p>Niezależnie od tego, który plugin wybierzemy, aplikujemy manifest za pomocą:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> ścieżka/do/manifestu
</code></pre></div></div>

<h2 id="konfiguracja-workera">Konfiguracja workera</h2>

<p>Konfiguracja workera sprowadza się do wywołania komendy wygenerowanej w czasie inicjalizacji klastra, np.:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm <span class="nb">join </span>192.168.1.101:6443 <span class="nt">--token</span> et57r8.rezqsvudyqfd0c3z <span class="nt">--discovery-token-ca-cert-hash</span> sha256:01e7e5a9a30b7a6d2b8a04465f50c5fe8c43f595b7e30cd325dfb494bd69b624
</code></pre></div></div>

<p>Po dodaniu wszystkich workerów do klastra, na masterze wykonujemy komendę:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubect get nodes 
</code></pre></div></div>

<p>W odpowiedzi powinniśmy otrzymać:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>k8s-master-1   Ready    control-plane   165m   v1.24.2
k8s-worker-3   Ready    &lt;none&gt;          159m   v1.24.2
k8s-worker-4   Ready    &lt;none&gt;          159m   v1.24.2
k8s-worker-5   Ready    &lt;none&gt;          159m   v1.24.2
k8s-worker-6   Ready    &lt;none&gt;          159m   v1.24.2
k8s-worker-7   Ready    &lt;none&gt;          159m   v1.24.2
</code></pre></div></div>

<p>I to wszystko, jeśli chodzi o podstawowy klaster k8s. Pozostaje poczekać na start wszystkich podów. Możemy to
zweryfikować za pomocą:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods <span class="nt">--all-namespaces</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kube-system            coredns-6d4b75cb6d-cztbh                    1/1     Running            0                167m
kube-system            coredns-6d4b75cb6d-w7n5l                    1/1     Running            0                167m
kube-system            etcd-k8s-master-1                           1/1     Running            7                167m
kube-system            kube-apiserver-k8s-master-1                 1/1     Running            7                167m
kube-system            kube-controller-manager-k8s-master-1        1/1     Running            4                167m
kube-system            kube-flannel-ds-5b29d                       1/1     Running            0                162m
kube-system            kube-flannel-ds-75sqv                       1/1     Running            0                162m
kube-system            kube-flannel-ds-gvr52                       1/1     Running            0                162m
kube-system            kube-flannel-ds-jhfnm                       1/1     Running            0                162m
kube-system            kube-flannel-ds-n5pnn                       1/1     Running            0                162m
kube-system            kube-flannel-ds-vjczl                       1/1     Running            0                167m
kube-system            kube-proxy-6p8hf                            1/1     Running            0                162m
kube-system            kube-proxy-6zmff                            1/1     Running            0                162m
kube-system            kube-proxy-75p5b                            1/1     Running            0                162m
kube-system            kube-proxy-7msjd                            1/1     Running            0                167m
kube-system            kube-proxy-ph9hf                            1/1     Running            0                162m
kube-system            kube-proxy-q7bxw                            1/1     Running            0                162m
kube-system            kube-scheduler-k8s-master-1                 1/1     Running            7                167m

</code></pre></div></div>

<p>W kolejnej części zaprezentuję jak skonfigurować dodatkowe elementy klastra (ingress, dns, loadbalancer itd.), tak aby wycisnąć z niego maksimum możliwości.</p>

<p>Wszystkie kroki (poza etapem konfiguracji płytek) można znaleźć <a href="https://github.com/m87/pi-k8s-base">tutaj</a> w formie playbooka Ansible.</p>


                    
                    
                    
                    <div class="did-you-know-box">
    <span class="highlighted-box-description">
        Artykuł należy do serii "Po godzinach", w której znajdują się wpisy dotyczące hobby luźno związanych z tematyką naszej codziennej pracy.
    </span>
</div>

                    
                </div>
            </div>
            <div class="sidebar">
                
<div class="sidebar-container">
    <div class="sidebar-title">
        Najnowsze wpisy
    </div>
    <div class="sidebar-latest-posts-container">
        <ul class="sidebar-posts"><li class="sidebar-post no-breaking-word">
                <a href="/2024/02/23/czy-wiesz-czym-jest-i-jak-dziala-webworker.html" lang="pl">Czy wiesz, czym jest i jak działa WebWorker?</a>
            </li><li class="sidebar-post no-breaking-word">
                <a href="/2024/01/26/czy-wiesz-jak-bezprzerwowo-zmienic-schemat-w-mongodb.html" lang="pl">Czy wiesz, jak bezprzerwowo zmienić schemat w MongoDB?</a>
            </li><li class="sidebar-post no-breaking-word">
                <a href="/2024/01/26/czy-wiesz-czym-jest-attribute-pattern-w-mongodb.html" lang="pl">Czy wiesz czym jest Attribute Pattern w MongoDB?</a>
            </li></ul>
    </div>
</div>

                <div class="sidebar-container" id="recommended-posts-sidebar">
    <div class="sidebar-title">
        Podobne wpisy
    </div>
    <div class="sidebar-latest-posts-container">
        <ul class="sidebar-posts" id="recommended-posts-desktop">

        </ul>
    </div>
</div>

                <div class="sidebar-container" id="recommended-posts-sidebar">
    <div class="sidebar-title">
        Dołącz do nas
    </div>
    <div class="sidebar-last-posts-container">
        <ul class="sidebar-posts">
            <li class="sidebar-post no-breaking-word">
                <a href="https://consdata.com/pl/kariera/trwajace-rekrutacje/poznan/senior-fullstack-developer-java-angular"
                   lang="pl">
                    <div class="job-offer">
                        <span class="job-title">SENIOR FULLSTACK DEVELOPER (JAVA + ANGULAR)</span>
                        <span class="job-description">Poznań (hybrydowo) lub zdalnie</span>
                        <span class="job-salary">
                            UoP 14 900 - 20 590 PLN brutto <br/>
                            B2B 19 680 - 27 220 PLN netto
                        </span>
                    </div>
                </a>
            </li>
            <li class="sidebar-post no-breaking-word">
                <a href="https://consdata.com/pl/kariera/trwajace-rekrutacje/poznan/regular-fullstack-developer-java-angular"
                   lang="pl">
                    <div class="job-offer">
                        <span class="job-title">REGULAR FULLSTACK DEVELOPER (JAVA + ANGULAR)</span>
                        <span class="job-description">Poznań (hybrydowo) lub zdalnie</span>
                        <span class="job-salary">
                            UoP 11 300 - 15 900 PLN brutto <br/>
                            B2B 14 950 - 21 000 PLN netto
                        </span>
                    </div>
                </a>
            </li>
            <li class="sidebar-post no-breaking-word">
                <a class="clickable-offer" href="https://www.consdata.com/pl/kariera/trwajace-rekrutacje#tag-developer">
                    <div class="other-job-offers">
                        <span class="job-title">ZOBACZ WSZYSTKIE OGŁOSZENIA</span>
                    </div>
                </a>
            </li>
        </ul>
    </div>
</div>

            </div>
        </div>
        <div class="post-post-section-mobile">
            
<div class="sidebar-container">
    <div class="sidebar-title">
        Najnowsze wpisy
    </div>
    <div class="sidebar-latest-posts-container">
        <ul class="sidebar-posts"><li class="sidebar-post no-breaking-word">
                <a href="/2024/02/23/czy-wiesz-czym-jest-i-jak-dziala-webworker.html" lang="pl">Czy wiesz, czym jest i jak działa WebWorker?</a>
            </li><li class="sidebar-post no-breaking-word">
                <a href="/2024/01/26/czy-wiesz-jak-bezprzerwowo-zmienic-schemat-w-mongodb.html" lang="pl">Czy wiesz, jak bezprzerwowo zmienić schemat w MongoDB?</a>
            </li><li class="sidebar-post no-breaking-word">
                <a href="/2024/01/26/czy-wiesz-czym-jest-attribute-pattern-w-mongodb.html" lang="pl">Czy wiesz czym jest Attribute Pattern w MongoDB?</a>
            </li></ul>
    </div>
</div>

        </div>
        <div class="post-post-section-mobile">
            <div class="sidebar-container" id="recommended-posts-bottombar">
    <div class="sidebar-title">
        Podobne wpisy
    </div>
    <div class="sidebar-latest-posts-container">
        <ul class="sidebar-posts" id="recommended-posts-mobile">

        </ul>
    </div>
</div>

        </div>
        <div class="post-post-section-mobile">
            <div class="sidebar-container" id="recommended-posts-sidebar">
    <div class="sidebar-title">
        Dołącz do nas
    </div>
    <div class="sidebar-last-posts-container">
        <ul class="sidebar-posts">
            <li class="sidebar-post no-breaking-word">
                <a href="https://consdata.com/pl/kariera/trwajace-rekrutacje/poznan/senior-fullstack-developer-java-angular"
                   lang="pl">
                    <div class="job-offer">
                        <span class="job-title">SENIOR FULLSTACK DEVELOPER (JAVA + ANGULAR)</span>
                        <span class="job-description">Poznań (hybrydowo) lub zdalnie</span>
                        <span class="job-salary">
                            UoP 14 900 - 20 590 PLN brutto <br/>
                            B2B 19 680 - 27 220 PLN netto
                        </span>
                    </div>
                </a>
            </li>
            <li class="sidebar-post no-breaking-word">
                <a href="https://consdata.com/pl/kariera/trwajace-rekrutacje/poznan/regular-fullstack-developer-java-angular"
                   lang="pl">
                    <div class="job-offer">
                        <span class="job-title">REGULAR FULLSTACK DEVELOPER (JAVA + ANGULAR)</span>
                        <span class="job-description">Poznań (hybrydowo) lub zdalnie</span>
                        <span class="job-salary">
                            UoP 11 300 - 15 900 PLN brutto <br/>
                            B2B 14 950 - 21 000 PLN netto
                        </span>
                    </div>
                </a>
            </li>
            <li class="sidebar-post no-breaking-word">
                <a class="clickable-offer" href="https://www.consdata.com/pl/kariera/trwajace-rekrutacje#tag-developer">
                    <div class="other-job-offers">
                        <span class="job-title">ZOBACZ WSZYSTKIE OGŁOSZENIA</span>
                    </div>
                </a>
            </li>
        </ul>
    </div>
</div>

        </div>
        <div class="author-bio">
    
    <div class="author-image">
        <a href="/authors/bradlinski.html" class="author-name">
            <img src="/assets/img/authors/bradlinski.webp" alt="author" width="120" height="120">
        </a>
    </div>
    
    <div class="card">
        <div class="header">
            
            <a href="/authors/bradlinski.html" class="author-name">
                Bartosz Radliński
            </a>
            
            <div class="social-buttons">
                
                <div class="author-github">
                    <a href="https://github.com/m87"
                       title="m87">
                        <svg class="svg-icon grey">
                            <use xlink:href="/assets/minima-social-icons.svg#github"></use>
                        </svg>
                        m87</a>
                </div>
                
            </div>
        </div>
        <div class="content">
            
                
                    <div class="bio">Full stack developer. Ostatnio wielbiciel zagadnień devopsowych, zwłaszcza wszystkiego, z czego da się złożyć cluster. W wolnych chwilach bawi się IoT, warzy piwo i dopieszcza konfigurację Gentoo.</div>
                
            
        </div>
    </div>
</div>
<div class="author-bio-mobile">
    <div class="header">
        
        <div class="author-image">
            <img src="/assets/img/authors/bradlinski.webp">
        </div>
        
        <div class="name-wrapper">
            
            <div class="author-name">Bartosz Radliński</div>
            
            <div class="social-buttons">
                
                <div class="author-github">
                    <a href="https://github.com/m87"
                       title="m87">
                        <svg class="svg-icon grey">
                            <use xlink:href="/assets/minima-social-icons.svg#github"></use>
                        </svg>
                        m87</a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="content">
        
            
            
                <div class="bio">Full stack developer. Ostatnio wielbiciel zagadnień devopsowych, zwłaszcza wszystkiego, z czego da się złożyć cluster. W wolnych chwilach bawi się IoT, warzy piwo i dopieszcza konfigurację Gentoo.</div>
            
        
    </div>
</div>
<div id="disqus_thread"></div>
<script>
    function readCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    if (readCookie('cookie-notice-dismissed') === 'true') {
        var disqus_config = function () {
            this.page.url = 'https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html';
            this.page.identifier = 'https://blog.consdata.tech/2022/10/14/k8s-raspberry-pi.html';
        };

        (function () {
            var d = document, s = d.createElement('script');

            s.src = 'https://consdata-tech.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    }
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
    powered by Disqus.</a></noscript></article>
</div>
<script>
    const language = 'pl';
    const jsonPath = language === 'en' ? '/en/json/posts.json' : '/json/posts.json';
    fetch(jsonPath)
        .then(response => response.json())
        .then(store => {
            function displayResults(results) {
                if (results.length > 0) {
                    const container = document.getElementById("recommended-posts-desktop");
                    const containerMobile = document.getElementById("recommended-posts-mobile");
                    results
                        .forEach(result => {
                            const item = store[result.ref];
                            if (item.lang === language) {
                                const listElement = document.createElement('li');
                                const anchor = document.createElement('a');
                                const postTitle = document.createTextNode(item.title);
                                listElement.classList.add('sidebar-post');
                                listElement.classList.add('no-breaking-word');
                                anchor.setAttribute('href', item.url);
                                anchor.setAttribute('lang', 'pl');
                                anchor.appendChild(postTitle);
                                listElement.appendChild(anchor);
                                container.appendChild(listElement);
                                containerMobile.appendChild(listElement.cloneNode(true));
                            }
                        });
                    if (container.children.length < 1) {
                        hideRecommendedPosts();
                    }
                } else {
                    hideRecommendedPosts();
                }

            }

            const tags = "k8s kubernetes devops raspberry-pi";
            const idx = lunr(function () {
                this.field('tags');

                for (let key in store) {
                    this.add({
                        'id': key,
                        'title': store[key].title,
                        'tags': store[key].tags,
                    });
                }
            });
            const results = idx.search(tags).slice(1, 4);
            displayResults(results);
        })

    function zoomImage($event) {
        const modal = document.getElementById('myModal');
        modal.getElementsByTagName('img')[0].src = $event.target.src;
        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('myModal').style.display = 'none';
    }

    function hideRecommendedPosts() {
        document.getElementById("recommended-posts-sidebar").style.display = 'none';
        document.getElementById("recommended-posts-bottombar").style.display = 'none';
    }

    const postImages = document.querySelectorAll('.post-content img');
    postImages.forEach(x => x.addEventListener('click', zoomImage));
</script>

</main><footer>
    <div class="container">
        <div class="footer-item company">
            <div class="label">
                <img src="/assets/img/logo.png"/>
            </div>
            <div class="item-content">
                <p>
                    K9OFFICE, UL. KRYSIEWICZA 9/17<br/>
                    61-825 POZNAŃ<br/>
                    POLSKA
                </p>
                <p>
                    TEL.:+48 61 41 51 000
                </p>
                <p>
                    NIP: 1822261960<br/>
                    REGON: 634422180
                </p>
            </div>
        </div>
        <div class="footer-item legals">
            <div class="label">
                INFORMACJE
            </div>
            <div class="item-content">
                <p>
                    <a href="https://consdata.com/pl/polityka-prywatnosci" target="_blank">POLITYKA PRYWATNOŚCI </a>
                </p>
            </div>
        </div>
        <div class="footer-item social-buttons">
            <div class="label">
                POZOSTAŃ W KONTAKCIE
            </div>
            <div class="item-content">
                <div class="social-buttons-container">
                    <div class="social-button-wrapper">
                        <a class="social-btn" target="_blank" href="https://www.facebook.com/consdatacom"
                           title="Facebook">
                            <i class="fa fa-facebook"></i>
                        </a>
                    </div>
                    <div class="social-button-wrapper">
                        <a class="social-btn" target="_blank"
                           href="https://www.youtube.com/channel/UCv4d_uCiLdDkOFk8NtDsU_w" title="Youtube">
                            <i class="fa fa-youtube"></i>
                        </a>
                    </div>
                    <div class="social-button-wrapper">
                        <a class="social-btn" target="_blank" href="https://www.linkedin.com/company/1456906"
                           title="Linkedin">
                            <i class="fa fa-linkedin"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="copyright">
        Copyrights © 2024 CONSDATA
    </div>
</footer>
<div class="cookie-notice" id="cookie-notice">
    <span>
        
        Chcemy używać plików cookie oraz skryptów podmiotów trzecich do polepszania funkcjonowania tej strony
    </span>
    <a id="cookie-notice-accept" class="consent-button">Zgadzam się</a>
    <i onclick="hideConsent()" class="close-consent fa fa-times close"></i>
    <noscript><img height="1" width="1" style="display:none"
                   src="https://www.facebook.com/tr?id=300808861525851&ev=PageView&noscript=1"
    /></noscript>
</div>

<script>
    function createCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + value + expires + "; path=/";
    }

    function readCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function eraseCookie(name) {
        createCookie(name, "", -1);
    }

    function hideConsent() {
        document.getElementById('cookie-notice').style.display = 'none';
    }

    if (readCookie('cookie-notice-dismissed') === 'true') {!function (f, b, e, v, n, t, s) {
    if (f.fbq) return;
    n = f.fbq = function () {
        n.callMethod ?
            n.callMethod.apply(n, arguments) : n.queue.push(arguments)
    };
    if (!f._fbq) f._fbq = n;
    n.push = n;
    n.loaded = !0;
    n.version = '2.0';
    n.queue = [];
    t = b.createElement(e);
    t.async = !0;
    t.src = v;
    s = b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t, s)
}(window, document, 'script',
    'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '300808861525851');
fbq('track', 'PageView');
} else {
        document.getElementById('cookie-notice').style.display = 'flex';
    }

    document.getElementById('cookie-notice-accept').addEventListener("click", function () {
        createCookie('cookie-notice-dismissed', 'true', 31);
        hideConsent();
        location.reload();
    });
</script>

</body>
</html>
